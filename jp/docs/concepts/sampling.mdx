---
title: "サンプリング"
description: "サーバーがLLMからの補完を要求できるようにする"
---

サンプリングは、サーバーがクライアントを通じてLLMの補完を要求できる強力なMCP機能であり、セキュリティとプライバシーを維持しながら高度なエージェント的行動を可能にします。

<Info>
  このMCPの機能は、Claude Desktopクライアントではまだサポートされていません。
</Info>

## サンプリングの仕組み

サンプリングのフローは以下のステップに従います：

1. サーバーが`sampling/createMessage`リクエストをクライアントに送信
2. クライアントがリクエストをレビューし、修正可能
3. クライアントがLLMからサンプリング
4. クライアントが補完をレビュー
5. クライアントが結果をサーバーに返す

この人間を介在させる設計により、ユーザーはLLMが何を見て生成するかを制御できます。

## メッセージフォーマット

サンプリングリクエストは標準化されたメッセージフォーマットを使用します：

```typescript
{
  messages: [
    {
      role: "user" | "assistant",
      content: {
        type: "text" | "image",

        // テキストの場合：
        text?: string,

        // 画像の場合：
        data?: string,             // base64エンコード
        mimeType?: string
      }
    }
  ],
  modelPreferences?: {
    hints?: [{
      name?: string                // 推奨モデル名/ファミリー
    }],
    costPriority?: number,         // 0-1, コスト最小化の重要性
    speedPriority?: number,        // 0-1, 低遅延の重要性
    intelligencePriority?: number  // 0-1, 機能の重要性
  },
  systemPrompt?: string,
  includeContext?: "none" | "thisServer" | "allServers",
  temperature?: number,
  maxTokens: number,
  stopSequences?: string[],
  metadata?: Record<string, unknown>
}
```

## リクエストパラメータ

### メッセージ

`messages`配列には、LLMに送信する会話履歴が含まれます。各メッセージには以下が含まれます：

- `role`: "user"または"assistant"
- `content`: メッセージの内容で、以下のいずれか：
  - `text`フィールドを持つテキストコンテンツ
  - `data`（base64）と`mimeType`フィールドを持つ画像コンテンツ

### モデルの好み

`modelPreferences`オブジェクトを使用して、サーバーはモデル選択の好みを指定できます：

- `hints`: クライアントが適切なモデルを選択するために使用できるモデル名の提案の配列：
  - `name`: フルまたは部分的なモデル名に一致する文字列（例: "claude-3", "sonnet"）
  - クライアントは異なるプロバイダーからの同等のモデルにヒントをマッピングすることができます
  - 複数のヒントは優先順に評価されます

- 優先度の値（0-1正規化）：
  - `costPriority`: コスト最小化の重要性
  - `speedPriority`: 低遅延応答の重要性
  - `intelligencePriority`: 高度なモデル機能の重要性

クライアントはこれらの好みと利用可能なモデルに基づいて最終的なモデル選択を行います。

### システムプロンプト

オプションの`systemPrompt`フィールドを使用して、サーバーは特定のシステムプロンプトを要求できます。クライアントはこれを修正または無視することができます。

### コンテキストの包含

`includeContext`パラメータは、どのMCPコンテキストを含めるかを指定します：

- "none": 追加のコンテキストなし
- "thisServer": 要求元サーバーからのコンテキストを含める
- "allServers": 接続されたすべてのMCPサーバーからのコンテキストを含める

クライアントは実際に含めるコンテキストを制御します。

### サンプリングパラメータ

LLMサンプリングを微調整するために：

- `temperature`: ランダム性を制御（0.0から1.0）
- `maxTokens`: 生成する最大トークン数
- `stopSequences`: 生成を停止するシーケンスの配列
- `metadata`: 追加のプロバイダー固有のパラメータ

## レスポンスフォーマット

クライアントは補完結果を返します：

```typescript
{
  model: string,  // 使用されたモデルの名前
  stopReason?: "endTurn" | "stopSequence" | "maxTokens" | string,
  role: "user" | "assistant",
  content: {
    type: "text" | "image",
    text?: string,
    data?: string,
    mimeType?: string
  }
}
```

## リクエストの例

以下は、クライアントからのサンプリングを要求する例です：
```json
{
  "method": "sampling/createMessage",
  "params": {
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "現在のディレクトリにあるファイルは何ですか？"
        }
      }
    ],
    "systemPrompt": "あなたは役に立つファイルシステムアシスタントです。",
    "includeContext": "thisServer",
    "maxTokens": 100
  }
}
```

## ベストプラクティス

サンプリングを実装する際には：

1. 常に明確で構造化されたプロンプトを提供する
2. テキストと画像の両方のコンテンツを適切に処理する
3. 適切なトークン制限を設定する
4. `includeContext`を通じて関連するコンテキストを含める
5. 応答を使用する前に検証する
6. エラーを優雅に処理する
7. サンプリングリクエストにレート制限を考慮する
8. 期待されるサンプリング動作を文書化する
9. さまざまなモデルパラメータでテストする
10. サンプリングコストを監視する

## 人間を介在させた制御

サンプリングは人間の監督を考慮して設計されています：

### プロンプトの場合

- クライアントはユーザーに提案されたプロンプトを表示するべきです
- ユーザーはプロンプトを修正または拒否できるべきです
- システムプロンプトはフィルタリングまたは修正可能です
- コンテキストの包含はクライアントによって制御されます

### 補完の場合

- クライアントはユーザーに補完を表示するべきです
- ユーザーは補完を修正または拒否できるべきです
- クライアントは補完をフィルタリングまたは修正可能です
- ユーザーは使用するモデルを制御します

## セキュリティ考慮事項

サンプリングを実装する際には：

- すべてのメッセージコンテンツを検証する
- 敏感な情報をサニタイズする
- 適切なレート制限を実装する
- サンプリングの使用を監視する
- データを転送中に暗号化する
- ユーザーデータのプライバシーを処理する
- サンプリングリクエストを監査する
- コストの露出を制御する
- タイムアウトを実装する
- モデルエラーを優雅に処理する

## 共通パターン

### エージェント的ワークフロー

サンプリングは以下のようなエージェント的パターンを可能にします：

- リソースの読み取りと分析
- コンテキストに基づいた意思決定
- 構造化データの生成
- マルチステップタスクの処理
- インタラクティブな支援の提供

### コンテキスト管理

コンテキストのベストプラクティス：

- 必要最小限のコンテキストを要求する
- コンテキストを明確に構造化する
- コンテキストサイズの制限を処理する
- 必要に応じてコンテキストを更新する
- 古いコンテキストをクリーンアップする

### エラーハンドリング

堅牢なエラーハンドリングは以下を行うべきです：

- サンプリングの失敗をキャッチする
- タイムアウトエラーを処理する
- レート制限を管理する
- 応答を検証する
- フォールバック動作を提供する
- エラーを適切にログに記録する

## 制限事項

これらの制限事項に注意してください：

- サンプリングはクライアントの機能に依存します
- ユーザーはサンプリングの動作を制御します
- コンテキストサイズには制限があります
- レート制限が適用される場合があります
- コストを考慮する必要があります
- モデルの利用可能性は異なります
- 応答時間は異なります
- すべてのコンテンツタイプがサポートされているわけではありません 