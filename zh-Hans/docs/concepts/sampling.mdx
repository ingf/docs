---
title: "采样"
description: "让您的服务器从 LLMs 请求补全"
---

采样是 MCP 的一个强大功能,它允许服务器通过客户端请求 LLM 补全,从而实现复杂的代理行为,同时保持安全性和隐私性。

<Info>
  Claude Desktop 客户端目前尚不支持 MCP 的这个功能。
</Info>

## 采样工作原理

采样流程遵循以下步骤:

1. 服务器向客户端发送 `sampling/createMessage` 请求
2. 客户端审查请求并可以修改它
3. 客户端从 LLM 采样
4. 客户端审查补全结果
5. 客户端将结果返回给服务器

这种人在环路的设计确保用户能够控制 LLM 看到和生成的内容。

## 消息格式

采样请求使用标准化的消息格式:

```typescript
{
  messages: [
    {
      role: "user" | "assistant",
      content: {
        type: "text" | "image",

        // 对于文本:
        text?: string,

        // 对于图片:
        data?: string,             // base64 编码
        mimeType?: string
      }
    }
  ],
  modelPreferences?: {
    hints?: [{
      name?: string                // 建议的模型名称/系列
    }],
    costPriority?: number,         // 0-1,最小化成本的重要性
    speedPriority?: number,        // 0-1,低延迟的重要性
    qualityPriority?: number       // 0-1,输出质量的重要性
  }
}
```

## 最佳实践

### 请求格式

采样请求应该:

- 包含清晰的指令
- 提供必要的上下文
- 指定所需的输出格式
- 包含相关的约束条件
- 设置适当的模型偏好

### 错误处理

实现应该:

- 处理采样失败
- 实现重试逻辑
- 设置超时
- 验证响应
- 控制成本暴露
- 实现超时
- 优雅地处理模型错误

## 常见模式

### 代理工作流

采样支持的代理模式包括:

- 读取和分析资源
- 基于上下文做出决策
- 生成结构化数据
- 处理多步骤任务
- 提供交互式帮助

### 上下文管理

上下文的最佳实践:

- 请求最少必要的上下文
- 清晰地组织上下文
- 处理上下文大小限制
- 根据需要更新上下文
- 清理过时的上下文

### 错误处理

健壮的错误处理应该:

- 捕获采样失败
- 处理超时错误
- 管理速率限制
- 验证响应
- 提供回退行为
- 适当记录错误

## 限制

请注意以下限制:

- 采样依赖于客户端能力
- 用户控制采样行为
- 上下文大小有限制
- 可能适用速率限制
- 应考虑成本
- 模型可用性不同
- 响应时间不同
- 不是所有内容类型都支持 